<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined">
    <title>AR Soyuzmultfilm</title>
</head>
<body>
    <canvas id="renderCanvas"></canvas>
    <div id="dom-overlay">
        <span id="add_icon" class="material-icons-outlined">add_circle</span>
        <span id="loading_text" style="display: none;">Загрузка модели...</span>
    </div>

    <!-- Babylon.js с поддержкой загрузки моделей -->
    <script src="https://cdn.babylonjs.com/babylon.js"></script>
    <script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>
    <script src="https://cdn.babylonjs.com/materialsLibrary/babylonjs.materials.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                let canvas = document.getElementById('renderCanvas');
                let domOverlay = document.querySelector('#dom-overlay');
                let addIcon = document.querySelector('#add_icon');
                let loadingText = document.querySelector('#loading_text');

                let engine = new BABYLON.Engine(canvas, true);
                let scene = new BABYLON.Scene(engine);
                scene.clearColor = new BABYLON.Color4(0, 0, 0, 0);

                // Освещение
                let light = new BABYLON.HemisphericLight('light', new BABYLON.Vector3(0, 1, 0), scene);
                light.intensity = 0.8;

                // Создаем XR опыт
                let xr = await scene.createDefaultXRExperienceAsync({
                    uiOptions: {
                        sessionMode: 'immersive-ar',
                        referenceSpaceType: 'local-floor',
                    }
                });

                let xrCamera = xr.baseExperience.camera;

                // DOM Overlay
                let featuresManager = xr.baseExperience.featuresManager;
                featuresManager.enableFeature(BABYLON.WebXRDomOverlay, 'latest', {
                    element: '#dom-overlay'
                }, undefined, false);

                // Обработка состояния XR
                xr.baseExperience.onStateChangedObservable.add((webXRState) => {
                    switch(webXRState) {
                        case BABYLON.WebXRState.IN_XR:
                            domOverlay.style.display = 'flex';
                            break;
                        case BABYLON.WebXRState.EXITING_XR:
                            domOverlay.style.display = 'none';
                            break;
                    }
                });

                let activeElement = null;

                // Функция загрузки модели
                // const loadModel = async (modelUrl, scene) => {
                //     loadingText.style.display = 'block';
                    
                //     try {
                //         // Загружаем модель
                //         const result = await BABYLON.SceneLoader.ImportMeshAsync(
                //             null, // загружаем все меши
                //             modelUrl, // базовый URL (если модель в той же папке)
                //             "", // имя файла модели
                //             scene
                //         );

                //         const model = result.meshes[0];
                //         model.scaling = new BABYLON.Vector3(0.1, 0.1, 0.1); // Масштабируем
                //         model.position = new BABYLON.Vector3(0, 0, -1);
                        
                //         // Включаем тени
                //         model.receiveShadows = true;
                        
                //         loadingText.style.display = 'none';
                //         return model;
                        
                //     } catch (error) {
                //         console.error('Ошибка загрузки модели:', error);
                //         loadingText.style.display = 'none';
                        
                //         // Создаем кубик как fallback
                //         let box = BABYLON.MeshBuilder.CreateBox('fallback', { size: 0.1 }, scene);
                //         box.material = new BABYLON.StandardMaterial('mat', scene);
                //         box.material.diffuseColor = new BABYLON.Color3(1, 0, 0);
                //         return box;
                //     }
                // };
									const loadModel = async (modelUrl, scene) => {
											loadingText.style.display = 'block';
											try {
													console.log('Пытаемся загрузить модель:', modelUrl); // Логируем для отладки
													const result = await BABYLON.SceneLoader.ImportMeshAsync(
															null, // Загружаем все меши
															modelUrl, // Базовый URL (папка с моделью)
															"", // Имя файла (пустое, если URL уже включает файл)
															scene
													);

													if (result.meshes.length === 0) {
															throw new Error('В файле нет мешей');
													}

													const model = result.meshes[0]; // Берём первый меш (корневой)
													model.scaling = new BABYLON.Vector3(0.1, 0.1, 0.1); // Масштабируем
													model.position = new BABYLON.Vector3(0, 0, -1); // Позиция по умолчанию
													
													// Включаем тени (если нужно)
													model.receiveShadows = true;
													
													loadingText.style.display = 'none';
													console.log('Модель загружена успешно:', model.name); // Логируем успех
													return model;
													
											} catch (error) {
													console.error('Ошибка загрузки модели:', error);
													loadingText.style.display = 'none';
													
													// Fallback: создаём кубик
													let box = BABYLON.MeshBuilder.CreateBox('fallback', { size: 0.1 }, scene);
													box.material = new BABYLON.StandardMaterial('mat', scene);
													box.material.diffuseColor = new BABYLON.Color3(1, 0, 0); // Красный кубик как индикатор ошибки
													return box;
											}
									};


                // Создаем объект с моделью
                const createObject = async () => {
                    try {
                        // Загружаем модель (замените на путь к вашей модели)
                        const model = await loadModel("https://github.com/NodevNofun/ar-sculptures/blob/ar_front/assets/models/cheburashka.glb", scene);
                        
                        // Позиционируем перед камерой
                        if (xrCamera.getFrontPosition) {
                            model.position = xrCamera.getFrontPosition(0.5);
                        } else {
                            model.position = new BABYLON.Vector3(0, 0, -1);
                        }
                        
                        // Добавляем анимацию вращения
                        scene.registerBeforeRender(() => {
                            model.rotation.y += 0.01;
                        });
                        
                        activeElement = model;
                        
                    } catch (error) {
                        console.error('Ошибка создания объекта:', error);
                    }
                };

                // Загружаем начальную модель при старте
                // let initialModel = await loadModel("http://localhost:9000/ar-content/models/e911640d-d3a2-4b57-ae12-283139780ea2_gena_the_crocodile.glb?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=admin%2F20250926%2Fus-east-1%2Fs3%2Faws4_request&X-Amz-Date=20250926T184405Z&X-Amz-Expires=86400&X-Amz-SignedHeaders=host&X-Amz-Signature=23a14c51904fbf2e6c4b4ef2c8e52076a7ba8c86db01c298c208c01455f9bebc", scene);
                // initialModel.position = new BABYLON.Vector3(0, 1, -2);

                // Рендер-луп
                engine.runRenderLoop(() => {
                    if (activeElement && xrCamera.getFrontPosition) {
                        activeElement.position = xrCamera.getFrontPosition(0.5);
                    }
                    scene.render();
                });

                // Обработка клика
                addIcon.addEventListener('click', createObject);

                window.addEventListener('resize', () => {
                    engine.resize();
                });

            } catch (error) {
                console.error('Ошибка инициализации:', error);
            }
        });
    </script>
</body>
</html>