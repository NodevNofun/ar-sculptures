<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, viewport-fit=cover">
    <title>AR World Tracking</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        
        body, html {
            width: 100%;
            height: 100%;
            overflow: hidden;
            position: fixed;
            font-family: Arial, sans-serif;
        }
        
        .ar-button {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 150, 255, 0.9);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            z-index: 1000;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255,255,255,0.3);
        }
        
        #status {
            position: fixed;
            top: 20px;
            left: 0;
            right: 0;
            text-align: center;
            color: white;
            background: rgba(0,0,0,0.7);
            padding: 10px;
            z-index: 1000;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <!-- AR —Å—Ü–µ–Ω–∞ -->
    <a-scene 
        vr-mode-ui="enabled: false"
        arjs="sourceType: webcam; 
              trackingMethod: world; 
              debugUIEnabled: false;
              sourceWidth: 1280;
              sourceHeight: 720;
              displayWidth: 1280; 
              displayHeight: 720;"
        embedded
        renderer="logarithmicDepthBuffer: true; precision: mediump;"
        device-orientation-permission-ui="enabled: false">
        
        <!-- –ö–∞–º–µ—Ä–∞ -->
        <a-camera-static></a-camera-static>
        
        <!-- –°—Ñ–µ—Ä–∞-–∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–ª–∏–∫–æ–≤ -->
        <a-sphere 
            id="testSphere"
            radius="0.05" 
            color="#FF0000" 
            position="0 0 -1"
            visible="false"
            class="clickable">
        </a-sphere>

        <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –º–æ–¥–µ–ª–µ–π -->
        <a-entity id="models-container"></a-entity>

        <!-- –û—Å–≤–µ—â–µ–Ω–∏–µ -->
        <a-entity light="type: ambient; color: #CCC; intensity: 0.6"></a-entity>
        <a-entity light="type: directional; color: #FFF; intensity: 0.8; position: 1 1 0.5"></a-entity>
    </a-scene>

    <!-- –≠–ª–µ–º–µ–Ω—Ç—ã UI -->
    <div id="status">–î–≤–∏–≥–∞–π—Ç–µ –∫–∞–º–µ—Ä–æ–π –≤–æ–∫—Ä—É–≥ —Å–µ–±—è –¥–ª—è –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–µ–π</div>
    <button class="ar-button" id="addButton">‚ûï –î–æ–±–∞–≤–∏—Ç—å –º–æ–¥–µ–ª—å</button>
    <button class="ar-button" id="clearButton" style="bottom: 80px; display: none;">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>

    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º A-Frame –∏ AR.js -->
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const scene = document.querySelector('a-scene');
            const status = document.getElementById('status');
            const addButton = document.getElementById('addButton');
            const clearButton = document.getElementById('clearButton');
            const testSphere = document.getElementById('testSphere');
            const modelsContainer = document.getElementById('models-container');
            
            let isARReady = false;
            let modelCount = 0;

            // –°–ø–∏—Å–æ–∫ –º–æ–¥–µ–ª–µ–π –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ (–ø—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ –ø—É—Ç–∏)
            const modelPaths = [
                // –õ–æ–∫–∞–ª—å–Ω—ã–µ –ø—É—Ç–∏
                "ar-sculptures/assets/models/cheburashka.glb",
                // –¢–µ—Å—Ç–æ–≤—ã–µ –º–æ–¥–µ–ª–∏ —Å GitHub
                'https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/master/2.0/Duck/glTF-Binary/Duck.glb',
                'https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/master/2.0/Box/glTF-Binary/Box.glb',
                'https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/master/2.0/Robot/glTF-Binary/Robot.glb'
            ];

            // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
            function updateStatus(message) {
                status.textContent = message;
                console.log(message);
            }

            // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–∏
            function loadModel(modelUrl) {
                return new Promise((resolve, reject) => {
                    const modelId = `model-${modelCount++}`;
                    const modelEntity = document.createElement('a-entity');
                    modelEntity.setAttribute('id', modelId);
                    
                    // –ü—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å GLTF –º–æ–¥–µ–ª—å
                    modelEntity.setAttribute('gltf-model', {
                        src: modelUrl
                    });
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
                    modelsContainer.appendChild(modelEntity);
                    
                    // –°–æ–±—ã—Ç–∏—è –∑–∞–≥—Ä—É–∑–∫–∏
                    modelEntity.addEventListener('model-loaded', () => {
                        console.log('‚úÖ –ú–æ–¥–µ–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω–∞:', modelUrl);
                        resolve(modelEntity);
                    });
                    
                    modelEntity.addEventListener('model-error', () => {
                        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', modelUrl);
                        modelsContainer.removeChild(modelEntity);
                        reject(new Error(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –º–æ–¥–µ–ª—å: ${modelUrl}`));
                    });
                    
                    // –¢–∞–π–º–∞—É—Ç
                    setTimeout(() => {
                        if (modelEntity.components['gltf-model'] && 
                            modelEntity.components['gltf-model'].model) {
                            resolve(modelEntity);
                        } else {
                            reject(new Error('–¢–∞–π–º–∞—É—Ç –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–∏'));
                        }
                    }, 3000);
                });
            }

            // –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –æ–±—ä–µ–∫—Ç–∞ –≤ AR
            async function createObject() {
                if (!isARReady) {
                    updateStatus('AR –µ—â–µ –Ω–µ –≥–æ—Ç–æ–≤. –ü–æ–¥–æ–∂–¥–∏—Ç–µ...');
                    return;
                }

                updateStatus('–ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–∏...');
                
                try {
                    // –ü—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å –º–æ–¥–µ–ª–∏ –ø–æ –ø–æ—Ä—è–¥–∫—É
                    let loadedModel = null;
                    
                    for (const modelPath of modelPaths) {
                        try {
                            updateStatus(`–ü—Ä–æ–±—É—é: ${modelPath}`);
                            loadedModel = await loadModel(modelPath);
                            if (loadedModel) break;
                        } catch (error) {
                            console.log(`–ù–µ —É–¥–∞–ª–æ—Å—å: ${modelPath}`);
                            continue;
                        }
                    }
                    
                    if (!loadedModel) {
                        throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∏ –æ–¥–Ω—É –º–æ–¥–µ–ª—å');
                    }
                    
                    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –∏ –º–∞—Å—à—Ç–∞–±
                    loadedModel.setAttribute('position', {
                        x: (Math.random() - 0.5) * 0.5,
                        y: Math.random() * 0.3,
                        z: -1 - Math.random() * 0.5
                    });
                    
                    loadedModel.setAttribute('scale', '0.1 0.1 0.1');
                    loadedModel.setAttribute('visible', 'true');
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
                    loadedModel.setAttribute('animation', {
                        property: 'rotation',
                        to: '0 360 0',
                        loop: true,
                        dur: 10000 + Math.random() * 10000
                    });
                    
                    updateStatus('–ú–æ–¥–µ–ª—å –¥–æ–±–∞–≤–ª–µ–Ω–∞! –¢–∞–ø–Ω–∏—Ç–µ –ø–æ —ç–∫—Ä–∞–Ω—É –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è');
                    clearButton.style.display = 'block';
                    
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –æ–±—ä–µ–∫—Ç–∞:', error);
                    updateStatus('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–∏. –°–æ–∑–¥–∞—é –∫—É–±...');
                    
                    // –°–æ–∑–¥–∞–µ–º fallback –∫—É–±
                    const box = document.createElement('a-box');
                    box.setAttribute('color', '#FF6B6B');
                    box.setAttribute('position', {
                        x: (Math.random() - 0.5) * 0.5,
                        y: Math.random() * 0.3,
                        z: -1 - Math.random() * 0.5
                    });
                    box.setAttribute('scale', '0.1 0.1 0.1');
                    box.setAttribute('animation', {
                        property: 'rotation',
                        to: '360 360 360',
                        loop: true,
                        dur: 8000
                    });
                    modelsContainer.appendChild(box);
                    
                    clearButton.style.display = 'block';
                }
            }

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π —Å—Ü–µ–Ω—ã
            scene.addEventListener('loaded', function() {
                updateStatus('–°—Ü–µ–Ω–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ...');
            });

            scene.addEventListener('arReady', function() {
                isARReady = true;
                updateStatus('AR –≥–æ—Ç–æ–≤! –î–≤–∏–≥–∞–π—Ç–µ –∫–∞–º–µ—Ä–æ–π –∏ –Ω–∞–∂–∏–º–∞–π—Ç–µ +');
                testSphere.setAttribute('visible', 'true');
            });

            scene.addEventListener('markerFound', function() {
                updateStatus('–ü–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç—å –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞!');
            });

            scene.addEventListener('markerLost', function() {
                updateStatus('–ò—â–µ–º –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏...');
            });

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–æ–≤ –ø–æ —Å—Ü–µ–Ω–µ
            scene.addEventListener('click', function(event) {
                if (isARReady && event.detail.intersection) {
                    createObject();
                }
            });

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫
            addButton.addEventListener('click', createObject);
            
            clearButton.addEventListener('click', function() {
                while (modelsContainer.firstChild) {
                    modelsContainer.removeChild(modelsContainer.firstChild);
                }
                modelCount = 0;
                clearButton.style.display = 'none';
                updateStatus('–°—Ü–µ–Ω–∞ –æ—á–∏—â–µ–Ω–∞');
            });

            // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö
            document.addEventListener('touchmove', function(e) {
                if (e.scale !== 1) {
                    e.preventDefault();
                }
            }, { passive: false });

            updateStatus('–ó–∞–≥—Ä—É–∑–∫–∞ AR...');
        });
    </script>
</body>
</html>