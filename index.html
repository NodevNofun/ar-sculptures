<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined">
    <title>AR Soyuzmultfilm</title>
</head>
<body>
    <canvas id="renderCanvas"></canvas>
    <div id="dom-overlay">
        <span id="add_icon" class="material-icons-outlined">add_circle</span>
        <span id="loading_text" style="display: none;">Загрузка модели...</span>
    </div>

    <!-- Babylon.js с поддержкой загрузки моделей -->
    <script src="https://cdn.babylonjs.com/babylon.js"></script>
    <script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>
    <script src="https://cdn.babylonjs.com/materialsLibrary/babylonjs.materials.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                let canvas = document.getElementById('renderCanvas');
                let domOverlay = document.querySelector('#dom-overlay');
                let addIcon = document.querySelector('#add_icon');
                let loadingText = document.querySelector('#loading_text');

                let engine = new BABYLON.Engine(canvas, true);
                let scene = new BABYLON.Scene(engine);
                scene.clearColor = new BABYLON.Color4(0, 0, 0, 0);

                // Освещение
                let light = new BABYLON.HemisphericLight('light', new BABYLON.Vector3(0, 1, 0), scene);
                light.intensity = 0.8;

                // Создаем XR опыт
                let xr = await scene.createDefaultXRExperienceAsync({
                    uiOptions: {
                        sessionMode: 'immersive-ar',
                        referenceSpaceType: 'local-floor',
                    }
                });

                let xrCamera = xr.baseExperience.camera;

                // DOM Overlay
                let featuresManager = xr.baseExperience.featuresManager;
                featuresManager.enableFeature(BABYLON.WebXRDomOverlay, 'latest', {
                    element: '#dom-overlay'
                }, undefined, false);

                // Обработка состояния XR
                xr.baseExperience.onStateChangedObservable.add((webXRState) => {
                    switch(webXRState) {
                        case BABYLON.WebXRState.IN_XR:
                            domOverlay.style.display = 'flex';
                            break;
                        case BABYLON.WebXRState.EXITING_XR:
                            domOverlay.style.display = 'none';
                            break;
                    }
                });

                let activeElement = null;

                // Функция загрузки модели
                const loadModel = async (modelUrl, scene) => {
                    loadingText.style.display = 'block';
                    
                    try {
                        // Загружаем модель
                        const result = await BABYLON.SceneLoader.ImportMeshAsync(
                            null, // загружаем все меши
                            "", // базовый URL (если модель в той же папке)
                            modelUrl, // имя файла модели
                            scene
                        );

                        const model = result.meshes[0];
                        model.scaling = new BABYLON.Vector3(0.1, 0.1, 0.1); // Масштабируем
                        model.position = new BABYLON.Vector3(0, 0, -1);
                        
                        // Включаем тени
                        model.receiveShadows = true;
                        
                        loadingText.style.display = 'none';
                        return model;
                        
                    } catch (error) {
                        console.error('Ошибка загрузки модели:', error);
                        loadingText.style.display = 'none';
                        
                        // Создаем кубик как fallback
                        let box = BABYLON.MeshBuilder.CreateBox('fallback', { size: 0.1 }, scene);
                        box.material = new BABYLON.StandardMaterial('mat', scene);
                        box.material.diffuseColor = new BABYLON.Color3(1, 0, 0);
                        return box;
                    }
                };

                // Создаем объект с моделью
                const createObject = async () => {
                    try {
                        // Загружаем модель (замените на путь к вашей модели)
                        const model = await loadModel('https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/master/2.0/Duck/glTF/Duck.gltf', scene);
                        
                        // Позиционируем перед амерой
                        if (xrCamera.getFrontPosition) {
                            model.position = xrCamera.getFrontPosition(0.5);
                        } else {
                            model.position = new BABYLON.Vector3(0, 0, -1);
                        }
                        
                        // Добавляем анимацию вращения
                        scene.registerBeforeRender(() => {
                            model.rotation.y += 0.01;
                        });
                        
                        activeElement = model;
                        
                    } catch (error) {
                        console.error('Ошибка создания объекта:', error);
                    }
                };

                // Загружаем начальную модель при старте
                let initialModel = await loadModel('https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/master/2.0/Duck/glTF/Duck.gltf', scene);
                initialModel.position = new BABYLON.Vector3(0, 1, -2);

                // Рендер-луп
                engine.runRenderLoop(() => {
                    if (activeElement && xrCamera.getFrontPosition) {
                        activeElement.position = xrCamera.getFrontPosition(0.5);
                    }
                    scene.render();
                });

                // Обработка клика
                addIcon.addEventListener('click', createObject);

                window.addEventListener('resize', () => {
                    engine.resize();
                });

            } catch (error) {
                console.error('Ошибка инициализации:', error);
            }
        });
    </script>
</body>
</html>